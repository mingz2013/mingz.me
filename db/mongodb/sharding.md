# Sharding


分片，是一种跨多台机器分布数据的方法，mongodb使用分片来支持具有非常大的数据集和高吞吐量操作的部署。


具有大数据集或高吞吐量应用程序的数据库系统可能会挑战单个服务器的容量。例如，高查询率会耗尽服务器的CPU容量。大于系统RAM的工作集大小会对磁盘驱动器的I/O容量造成压力。


解决系统增长的方法有两种：垂直和水平缩放。

垂直扩展，包括增加单个服务器的容量，例如使用更强大的CPU，更多的RAM，更多的存储空间。垂直缩放有一个实际的最大值。



横向扩展，包括将系统数据集和负载划分到多台服务器上，根据需要添加额外的服务器以增加容量。虽然一台机器的整体速度或容量可能不高，但每台机器都处理整体工作负载的一个子集，可能比单个高速高容量服务器提供更好的效率。
扩展部署的容量只需要根据需要添加额外的服务器，这可能比单台机器的高端硬件的总体成本更低。权衡是增加了部署的基础设施和维护的复杂性。


MongoDB通过分片进行水平缩放。


## Sharded Cluster

一个分片集群包含下面几个组件：

- shard: 每一个分片包含了分片数据的一个子集，每一个分片可以被部署为一个副本集。
- mongos：mongos职责是作为一个请求的路由，提供一个接口，处于客户端程序和分片集群中间。
- config servers: 配置服务器存储元数据和集群的配置信息。配置服务器必须部署为一个副本集。

![](./images/sharded-cluster-production-architecture.bakedsvg.svg)


分片数据是在collection 的级别，分布集合的数据到分片集群上。



## Shard Keys

mongodb使用片键在不同的分片之间分发集合的文档。
片键由目标集合中每个文档存在的一个或多个字段组成。

在对一个集合进行分片时选择片键。一旦选择，不能更改。一个分片集合只能有一个片键。

要对非空集合进行分片，集合必须具有以片键开始的索引。
对一个空的集合进行分片，如果集合没有针对指定的片键的适当索引，mongodb将创建索引。


选择分片会影响分片集群的性能，效率和可伸缩性。片键可能会阻碍具有最佳硬件和基础结构的集群。片键的选择及其支持索引也会影响集群使用分片的策略。



## Chunks
mongodb将分片数据分割成块。每一个块都有一个基于片键的包含的范围。



## Balancer and Even Chunk Distribution
为了在集群的所有分片上实现块的均匀分布，在后台运行一个均衡器来跨分片迁移块。


## Advantages of Sharding (分片的优势)

### Reads/Writes

